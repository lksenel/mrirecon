
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>PESCaT Demo</title><meta name="generator" content="MATLAB 8.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2018-01-10"><meta name="DC.source" content="demo_PESCaT.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>PESCaT Demo</h1><!--introduction--><p>Reconstruction by Projetion over Epigraph Sets and Calibration over Tensors (PESCaT) Demo</p><p>This is a demo that shows an example implementation of PESCaT algorithm over bSSFP data with multiple phase-cycled acquisitions and coils. It is based on Shahdloo et. al, "Projection onto Epigraph Sets for Rapid Self-Tuning Compressed Sensing MRI". PESCaT is a technique that employs projection onto epigraph sets of L1 and TV norm functions to self-tune the regularization parameters. A tensor interpolation kernel is estimated over the aggregated data across coils and phase cycles and used to fill missing k-space points.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">Parameters</a></li><li><a href="#3">Necessary libraries and folders</a></li><li><a href="#5">Loading tutorial data</a></li><li><a href="#6">Loading undersampling Mask</a></li><li><a href="#7">Reference Image</a></li><li><a href="#8">Prepare Data</a></li><li><a href="#10">Create PESCaT instance</a></li><li><a href="#11">Perfrorm reconstruction</a></li><li><a href="#12">Outputting the results</a></li><li><a href="#16">Alternative reconstruction</a></li></ul></div><pre class="codeinput">clearvars;
close <span class="string">all</span>;
</pre><h2>Parameters<a name="2"></a></h2><p>The provided dataset in this tutorial have four coils and eight datasets. In multi-acquisition bSSFP imaging, each phase-cycled acquisition is accelerated by a factor equal to the total number of acquisitions to keep the acquisition time intact. Here we use N=4 phase-cycles and R=4 acceleration factor. In the end, images are p-norm combined with p=2 across coils and p=4 across acquisitions. To compare the PESCaT reconstruction with convensional reconstructions using the SURE criterion, and alternative reconstruction is also performed.</p><pre class="codeinput">N = 4; <span class="comment">% number of phase-cycled acquisitions</span>
R = 4; <span class="comment">% acceleration factor</span>
p_acq = 4; <span class="comment">% p value for p-norm combination over phase-cycles</span>
p_coils = 2; <span class="comment">% p value for p-norm combination over coils</span>

reconSURE = 1; <span class="comment">% do you want SURE reconstruction too?</span>
</pre><h2>Necessary libraries and folders<a name="3"></a></h2><p>SPIRiT V0.3 is required for the wavelet operations, check for it.</p><pre class="codeinput"><span class="keyword">if</span> exist(<span class="string">'crop.m'</span>, <span class="string">'file'</span>)==0
	addpath(genpath(<span class="string">'ESPIRiT'</span>));
	<span class="keyword">if</span> exist(<span class="string">'crop.m'</span>, <span class="string">'file'</span>)==0
		warning(<span class="string">'ReCat utilizes SPIRiT V0.3 library. Please download from http://people.eecs.berkeley.edu/~mlustig/Software.html and copy the "ESPIRiT" directory to the same directory as this demo file. '</span>);
		<span class="keyword">return</span>;
	<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><p>Adding the util folder that includes some utility functions</p><pre class="codeinput"><span class="keyword">if</span> exist(<span class="string">'normalize.m'</span>, <span class="string">'file'</span>)==0
	addpath(<span class="string">'util'</span>);
<span class="keyword">end</span>
</pre><h2>Loading tutorial data<a name="5"></a></h2><p>load sample bSSFP data</p><pre class="codeinput">load(<span class="string">'data/invivo_4coil.mat'</span>);
raw_data = double(raw_data); <span class="comment">% LSQR implementation requires double type</span>
</pre><h2>Loading undersampling Mask<a name="6"></a></h2><p>load pre-generated mask</p><pre class="codeinput">load([<span class="string">'masks/mask_'</span> num2str(R) <span class="string">'x.mat'</span>]);
</pre><h2>Reference Image<a name="7"></a></h2><p>Generate the fully-sampled reference via p-norm combination over N=4 of the fully-sampled acquisitions</p><pre class="codeinput">images = ifft2c(raw_data(:,:,1:2:8,:));
originalImage = sos(sos(images,4,p_coils),3,p_acq);
</pre><h2>Prepare Data<a name="8"></a></h2><p>Take N-many acquisitions</p><pre class="codeinput">imageFFT = reshape(raw_data(:,:,1:8/R:8,:),[size(images,1),size(images,2),1,N,size(images,4)]);
</pre><p>In reality, the sampling masks are different across acquisitions but the same across slices and coils. Undersampled data is assessed by multiplying the k-space data with the undersampling mask.</p><pre class="codeinput">mask = repmat(mask(:,:,1:8/R:8),[1,1,1,size(imageFFT,3),size(imageFFT,5)]);
mask = permute(mask,[1,2,4,3,5]);
sampling.mask = mask;
maskedData = imageFFT.*mask;
</pre><h2>Create PESCaT instance<a name="10"></a></h2><p>A PESCaT object is instantiated with the default properties. These can be modified by passing extra arguments to the object instantiator.</p><pre class="codeinput">pobj = PESCaT(maskedData,sampling);
</pre><h2>Perfrorm reconstruction<a name="11"></a></h2><p>The reconPESCaT method performs the reconstruction on the data passed to the PESCaT object.</p><pre class="codeinput">pobj.reconPESCaT();
</pre><pre class="codeoutput">training the kernel...done
reconstructing slice 1...done
</pre><h2>Outputting the results<a name="12"></a></h2><p>Normalize both reference image and reconstructed image to 0-1.</p><pre class="codeinput">originalImage = normalize(originalImage);
result = normalize(pobj.recon);
</pre><p>Display the reconstruction and the reference images.</p><pre class="codeinput">figure; imshow(originalImage);
title(<span class="string">'Fully Sampled Image'</span>);
figure; imshow(result);
title(<span class="string">'PESCaT Reconstructed Image'</span>);
</pre><img vspace="5" hspace="5" src="demo_PESCaT_01.png" alt=""> <img vspace="5" hspace="5" src="demo_PESCaT_02.png" alt=""> <p>Print the PSNR using the fully-sampled reference.</p><pre class="codeinput">fprintf(<span class="string">'PESCaT PSNR: %.2f\n'</span>, psnr(result, originalImage));
</pre><pre class="codeoutput">PESCaT PSNR: 40.15
</pre><p>Print the elapsed time.</p><pre class="codeinput">fprintf(<span class="string">'PESCaT elapsed time: %.2f\n'</span>, sum(pobj.optimParams.elapsed));
</pre><pre class="codeoutput">PESCaT elapsed time: 137.10
</pre><h2>Alternative reconstruction<a name="16"></a></h2><p>This conditional statement performs the reconstruction using the convensional method and outputs the results.</p><pre class="codeinput"><span class="keyword">if</span> reconSURE
</pre><p>Create PESCaT instance with sparsity and TV projections set to `SURE'</p><pre class="codeinput">    sobj = PESCaT(maskedData,sampling,<span class="string">'sparsityType'</span>,<span class="string">'SURE'</span>,<span class="string">'TVType'</span>,<span class="string">'SURE'</span>);
</pre><p>Perfrorm reconstruction</p><pre class="codeinput">    sobj.reconPESCaT();
    resultSURE = normalize(sobj.recon);
</pre><pre class="codeoutput">training the kernel...done
reconstructing slice 1...done
</pre><p>Output the results</p><pre class="codeinput">    figure; imshow(originalImage);
    title(<span class="string">'Fully Sampled Image'</span>);
    figure; imshow(resultSURE);
    title(<span class="string">'SURE Reconstructed Image'</span>);

    fprintf(<span class="string">'SURE PSNR: %.2f\n'</span>, psnr(resultSURE, originalImage));
    fprintf(<span class="string">'SURE elapsed time: %.2f\n'</span>, sum(sobj.optimParams.elapsed));
</pre><pre class="codeoutput">SURE PSNR: 39.46
SURE elapsed time: 693.12
</pre><img vspace="5" hspace="5" src="demo_PESCaT_03.png" alt=""> <img vspace="5" hspace="5" src="demo_PESCaT_04.png" alt=""> <pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% PESCaT Demo
% Reconstruction by Projetion over Epigraph Sets and Calibration over
% Tensors (PESCaT) Demo
%
% This is a demo that shows an example implementation
% of PESCaT algorithm over bSSFP data with multiple phase-cycled
% acquisitions and coils. It is based on Shahdloo et. al, "Projection onto
% Epigraph Sets for Rapid Self-Tuning Compressed Sensing MRI". PESCaT is a
% technique that employs projection onto epigraph sets of L1 and TV norm
% functions to self-tune the regularization parameters. A tensor
% interpolation kernel is estimated over the aggregated data across coils
% and phase cycles and used to fill missing k-space points.

%%

clearvars;
close all;

%% Parameters
% The provided dataset in this tutorial have four coils and eight datasets.
% In multi-acquisition bSSFP imaging, each phase-cycled acquisition is
% accelerated by a factor equal to the total number of acquisitions to keep
% the acquisition time intact. Here we use N=4 phase-cycles and R=4
% acceleration factor. In the end, images are p-norm combined with p=2
% across coils and p=4 across acquisitions.
% To compare the PESCaT reconstruction with convensional reconstructions
% using the SURE criterion, and alternative reconstruction is also
% performed.

N = 4; % number of phase-cycled acquisitions
R = 4; % acceleration factor
p_acq = 4; % p value for p-norm combination over phase-cycles
p_coils = 2; % p value for p-norm combination over coils

reconSURE = 1; % do you want SURE reconstruction too?

%% Necessary libraries and folders
% SPIRiT V0.3 is required for the wavelet operations, check for it.
if exist('crop.m', 'file')==0
	addpath(genpath('ESPIRiT'));
	if exist('crop.m', 'file')==0
		warning('ReCat utilizes SPIRiT V0.3 library. Please download from http://people.eecs.berkeley.edu/~mlustig/Software.html and copy the "ESPIRiT" directory to the same directory as this demo file. ');
		return;
	end
end
%%
% Adding the util folder that includes some utility functions
if exist('normalize.m', 'file')==0
	addpath('util');
end

%% Loading tutorial data
% load sample bSSFP data
load('data/invivo_4coil.mat');
raw_data = double(raw_data); % LSQR implementation requires double type

%% Loading undersampling Mask
% load pre-generated mask
load(['masks/mask_' num2str(R) 'x.mat']);

%% Reference Image
% Generate the fully-sampled reference via p-norm combination over N=4 of
% the fully-sampled acquisitions

images = ifft2c(raw_data(:,:,1:2:8,:));
originalImage = sos(sos(images,4,p_coils),3,p_acq);

%% Prepare Data
% Take N-many acquisitions
imageFFT = reshape(raw_data(:,:,1:8/R:8,:),[size(images,1),size(images,2),1,N,size(images,4)]);
%%
% In reality, the sampling masks are different across acquisitions but the
% same across slices and coils. Undersampled data is assessed by
% multiplying the k-space data with the undersampling mask.
mask = repmat(mask(:,:,1:8/R:8),[1,1,1,size(imageFFT,3),size(imageFFT,5)]);
mask = permute(mask,[1,2,4,3,5]);
sampling.mask = mask;
maskedData = imageFFT.*mask;

%% Create PESCaT instance
% A PESCaT object is instantiated with the default properties. These can be
% modified by passing extra arguments to the object instantiator.
pobj = PESCaT(maskedData,sampling);

%% Perfrorm reconstruction
% The reconPESCaT method performs the reconstruction on the data passed to
% the PESCaT object.
pobj.reconPESCaT();

%% Outputting the results
% Normalize both reference image and reconstructed image to 0-1.
originalImage = normalize(originalImage);
result = normalize(pobj.recon);
%%
% Display the reconstruction and the reference images.
figure; imshow(originalImage);
title('Fully Sampled Image');
figure; imshow(result);
title('PESCaT Reconstructed Image');
%%
% Print the PSNR using the fully-sampled reference.
fprintf('PESCaT PSNR: %.2f\n', psnr(result, originalImage));
%%
% Print the elapsed time.
fprintf('PESCaT elapsed time: %.2f\n', sum(pobj.optimParams.elapsed));

%% Alternative reconstruction
% This conditional statement performs the reconstruction using the
% convensional method and outputs the results.

if reconSURE
    %%
    % Create PESCaT instance with sparsity and TV projections set to `SURE'
    sobj = PESCaT(maskedData,sampling,'sparsityType','SURE','TVType','SURE');
    %%
    % Perfrorm reconstruction
    sobj.reconPESCaT();
    resultSURE = normalize(sobj.recon);
    %%
    % Output the results
    figure; imshow(originalImage);
    title('Fully Sampled Image');
    figure; imshow(resultSURE);
    title('SURE Reconstructed Image');
    
    fprintf('SURE PSNR: %.2f\n', psnr(resultSURE, originalImage));
    fprintf('SURE elapsed time: %.2f\n', sum(sobj.optimParams.elapsed));
end

##### SOURCE END #####
--></body></html>